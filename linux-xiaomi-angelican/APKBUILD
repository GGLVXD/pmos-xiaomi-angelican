# Reference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: arch/arm64/configs/(CHANGEME!)

pkgname=linux-xiaomi-angelican
pkgver=4.9.190
pkgrel=0
pkgdesc="Xiaomi Redmi 9C NFC kernel fork"
arch="aarch64"
_carch="arm64"
_flavor="xiaomi-angelican"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
gpu_accelerated=true
makedepends="
	bash
	bc
	bison
	devicepkg-dev
	findutils
	flex
	openssl-dev
	perl
"

# Source
_author="droidian-mt6765"
_repository="kernel-xiaomi-mt6765"
_commit="d31e916b28ccf4419c00e6e774841e7d65df06c5"
_config="config-$_flavor.$arch"
source="
	$pkgname-$_commit.tar.gz::https://github.com/$_author/$_repository/archive/$_commit.tar.gz
	$_config::https://raw.githubusercontent.com/$_author/$_repository/$_commit/arch/$_carch/configs/angelican_defconfig
"


	# gcc7-give-up-on-ilog2-const-optimizations.patch
	# gcc8-fix-put-user.patch
	# gcc10-extern_YYLOC_global_declaration.patch
	# kernel-use-the-gnu89-standard-explicitly.patch

builddir="$srcdir/$_repository-$_commit"
_outdir="out"

prepare() {
	# export PY2_PREFIX="$srcdir/python2"
	# mkdir -p "$PY2_PREFIX"
	# wget https://www.python.org/ftp/python/2.7.18/Python-2.7.18.tgz -O "$srcdir/Python-2.7.18.tgz"
	# tar -xzf "$srcdir/Python-2.7.18.tgz" -C "$srcdir"
	# cd "$srcdir/Python-2.7.18"
	# ./configure --prefix="$PY2_PREFIX" --enable-optimizations
	# make -j$(nproc)
	# make install
	# export PATH="$PY2_PREFIX/bin:$PATH"
	# cd "$builddir"

	default_prepare
	. downstreamkernel_prepare
}

build() {
	unset LDFLAGS
	# export PATH="$srcdir/python2/bin:$PATH"
	make O="$_outdir" ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS"
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" "$_carch" \
		"$_flavor" "$_outdir"
}

sha512sums="
0f57f5b30e76949b9b8835dac5d1d1eedbc8602605f76106f7c9425a4844f2bc01c9736c84c64388cc884a4812d04e4e16597b1d930f0c0cd5cca0ac77802291  linux-xiaomi-angelican-d31e916b28ccf4419c00e6e774841e7d65df06c5.tar.gz
ce3893cf439868f4b0a6ed5a47de99cc6e2a3cd68cb132e3c43d64bf1ef509a6df9a38d0984cb0f36d0c4ee5170e07185532f4749f61c33dd3e2c5d8385cdfd2  config-xiaomi-angelican.aarch64
"
