# Reference: https://gitlab.com/ubports/porting/community-ports/android10/xiaomi-redmi-9c/kernel-xiaomi-mt6765
# Kernel config based on: arch/arm64/configs/angelican_defconfig

pkgname=linux-xiaomi-angelican
pkgver=4.9.190
pkgrel=0
pkgdesc="Xiaomi Redmi 9C NFC kernel fork"
arch="aarch64"
_carch="arm64"
_flavor="xiaomi-angelican"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="
	bash
	bc
	bison
	devicepkg-dev
	flex
	openssl-dev
	perl
	python3
"

# Source
_repository="kernel-xiaomi-mt6765"
_commit="5b52fedbe4d7c6809b5040f7486a8b72812f3fba"
_config="config-$_flavor.$arch"
source="
	$pkgname-$_commit.tar.gz::https://gitlab.com/ubports/porting/community-ports/android10/xiaomi-redmi-9c/$_repository/-/archive/$_commit/$_repository-$_commit.tar.gz
	$_config
	001-touchscreen-firmware-loading-time.patch
	002-battery-percentage.patch
"
builddir="$srcdir/$_repository-$_commit"
_outdir="out"

prepare() {
	default_prepare
	. downstreamkernel_prepare
}

build() {
	unset LDFLAGS
	make O="$_outdir" ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS"
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" "$_carch" \
		"$_flavor" "$_outdir"

	make dtbs_install O="$_outdir" ARCH="$_carch" \
		INSTALL_DTBS_PATH="$pkgdir"/boot/dtbs

  make modules_install O="$_outdir" ARCH="$_carch" \
    INSTALL_DTBS_PATH="$pkgdir"/boot/dtbs \
    INSTALL_MOD_PATH="$pkgdir" INSTALL_MOD_STRIP=1

	cat "$pkgdir"/boot/dtbs/mediatek/*.dtb > "$pkgdir"/boot/dtbs/mediatek/merged.dtb
}

sha512sums="
beeaa1b5b5d3e6f635508c6f421051080f7fdc296909db7448e4c706b6a54755badc2ea0c1316dbf0a1d394dbea15266a84dfa36d9818c8df99747484c9175b6  linux-xiaomi-angelican-5b52fedbe4d7c6809b5040f7486a8b72812f3fba.tar.gz
ce3893cf439868f4b0a6ed5a47de99cc6e2a3cd68cb132e3c43d64bf1ef509a6df9a38d0984cb0f36d0c4ee5170e07185532f4749f61c33dd3e2c5d8385cdfd2  config-xiaomi-angelican.aarch64
3fc36011ab030382f6b74e3821dcc75a236e12fe38bf18639fededc6c49a8c809d9ca1af5a9f2ed83f5f412a383918db14b4af48eda7087ec5997ca00e018152  001-touchscreen-firmware-loading-time.patch
2ed25978e3c91addf7e568b68ccb6036aa581da0981ec75527e25d15d0ee7dfed97100376e58ce6a6c07ef8a96210a30c0ad91b3cea29528aa89fc59980691bf  002-battery-percentage.patch
"
